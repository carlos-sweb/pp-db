<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">

	<title>pp-db</title>
</head>
<body>


<main id="main" class="container"></main>


<script type="text/javascript">

(function(root){


  
  		// In the following line, you should include the prefixes of implementations you want to test.
window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
// DON'T use "var indexedDB = ..." if you're not in a function.
// Moreover, you may need references to some window.IDB* objects:
window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"}; // This line should only be needed if it is needed to support the object's constants for older browsers
window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
// (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)







// ==============================================================
root.ppDB = function( options ){

		this.DB = indexedDB
		// ----------------------------------------------------------
		this.request = indexedDB.open(options.name , options.version );

		this.add = function( table , data , done){

				 
					var db = 	this.request.result;
					var transaction = db.transaction(table, "readwrite");
					var objectStore = transaction.objectStore(table);
					data.forEach((item) => {
							var objectStoreRequest = objectStore.add(item);	
							objectStoreRequest.onsuccess = function(){
									done(this , item )
							}.bind(this)
					});
										
				
		}

		this.getAll = function( table , done ){
				var db = this.request.result;
				var transaction = db.transaction(table, "readwrite");
				var objectStore = transaction.objectStore(table);
				
				var request = objectStore.getAll()

				request.onsuccess = function( event ){
							done( request.result)
				}
				


				

		}	

		// ----------------------------------------------------------
		this.request.onerror = function( error ){
				console.log("Error : ");
				console.log( error );
		}
		// ----------------------------------------------------------
		this.request.onupgradeneeded = function( event ){

			var db = event.target.result;			
			console.log( );
			options.tables.forEach(( table )=>{					
					
					var objectStore = db.createObjectStore( table.table, { keyPath: "id", autoIncrement:true });

					console.log(objectStore);
					
					/*
					table.fields.forEach(( field )=>{
							objectStore.createIndex(field.name,field.name,{unique:false});
					});
					*/
					
					objectStore.transaction.oncomplete = function(event) {

							var tableObjectStore = db.transaction(table.table, "readwrite").objectStore(table.table);
							table.data.forEach((data)=>{
									tableObjectStore.add(data)
							});

					}

			});
			

		}
}
// ==============================================================
})(window)



var submit = function( event ){



	var data = new FormData(event.target);

	console.log( data);
	console.log(event.target);

}

var createList = function( data ){

		var body = document.getElementById("main") , vtr = '';
		vtr += `

			<form id="formAdd" name="form1">
			<fieldset>
					<label for="name">Name</label>
					<input type="text" name="name" id="name">
					<label for="number">Number</label>
					<input type="text" name="number" id="number">
					<input class="button-primary" type="submit" value="Send">
			</fieldset>
			</form>
			<form>



			<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Number</th>      
      <th></th>
    </tr>
  </thead>
  <tbody>

 



		`;
		vtr += "<ul>";
		data.forEach(( item)=>{
				vtr +=  `<tr><td>${item.name} </td><td>${item.number}</td><td><button onclick="event.preventDefault()">Delete</button></td></li> `
		});
		vtr += `				
		  </tbody>
		</table>`;




		body.innerHTML = vtr;


		document.querySelector("form[id=formAdd]").addEventListener('submit',function(event){
				event.preventDefault();
				var data = new FormData(event.target);
				const insert = {'name':data.get('name'),'number':data.get('number')}

				db.add('contacts',[insert],function(){
					db.getAll("contacts",createList);
				});



		})


}


var db = new ppDB({
	name:"customer",
	version : 1 , 
	tables:[{
		table:"contacts",		
		fields:[{name : 'name'},{name : 'number'}],
		data:[
			{'name':'Carlos Illesca','number':'+56964573739'},
			{'name':'Daisy Montenegro','number':'+56964573739'}
		]

	}]
});


setTimeout( () => {

		/*
		db.add("contacts",[{
			'name':'Pedro',
			'number':'0000'
		}],function(){
			console.log("toda la data agregada");
		});
		*/

		db.getAll("contacts",createList);

},1000);



</script>	
</body>
</html>
